---
title: "Google Mobility Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mobility_google}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE, include=FALSE}
library(covid19interventions)
library(rvest)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(readr)
library(DT)
```

## State/County Stay at Home Dates from NYTimes
```{r}
# website with stay at home/shelter in place orders
url <- xml2::read_html("https://www.nytimes.com/interactive/2020/us/coronavirus-stay-at-home-order.html")

# identify elements to scrape at the state level
td_tags <- c('h3', 'p.l-order')
sah_ = list()

# loop through multiple elements to scrape 
for (i in td_tags){
  sah_[[i]] = url %>%
  html_nodes('div.state-wrap.statewide')  %>%
  html_nodes(i) %>% 
  html_text
}

# list to Dataframe conversion
names(sah_) <- c('state','order')
sah <- as.data.frame(sah_)
sah["county"] <- 'All'

# States that did not implement a stay at home order
# Pull the county level info with state attached
no_sah <- html_nodes(url, "div.state-wrap ")
for (section in no_sah) {
  state <- html_nodes(section, "h3") %>% html_text
  place <- html_nodes(section, "p.l-place") %>% html_text
  order <- html_nodes(section, "p.l-order") %>% html_text
  # counties under l-place class for every state
  # if state has implemented SAH in one or more county
  # extract county level SAH data
  if (length(place) >= 1){
    sah <- sah %>% add_row(state = state, order = order, county = place)
  }
}

# Format Columns
sah$state = unlist(lapply(sah$state,function(x){
  paste(unlist(strsplit(as.character(x)," About "))[1],collapse = " ")}))
sah$county = unlist(lapply(sah$county,function(x){
  paste(unlist(strsplit(as.character(x)," About "))[1],collapse = " ")}))
sah$order_type = unlist(lapply(sah$order,function(x){
  paste(unlist(strsplit(as.character(x),", effective "))[1],collapse = "")}))
sah$date_time = unlist(lapply(sah$order,function(x){
  paste(unlist(strsplit(as.character(x),", effective "))[2],collapse = "")}))
sah$time = unlist(lapply(sah$date,function(x){
  paste(unlist(strsplit(as.character(x)," at "))[2],collapse = "")}))
sah$date <- unlist(lapply(sah$date,function(x){
  paste(unlist(strsplit(as.character(x)," at "))[1],collapse = "")}))

# Fix date & Filter columns
sah$order_date <- as.Date(sah$date,format = "%B %d")
sah <- sah[c("state", "county", "order_type", "order_date", "time")]
```


## Google Mobility Data
- Find date of biggest drop in mobility by county using google data
- Check if this happens before or after SAH order is implemented
- If a big drop before SAH -> there may be some county level implementation (?)
```{r, fig.align='center', fig.width=8, fig.height=5}
# global dataset
mob_data <- read_csv("data/Global_Mobility_Report.csv")
mob_data$date = as.Date(mob_data$date, format = '%m/%d/%Y')

# filter data to county level data only
mob_data_filtered <- mob_data %>% filter(!is.na(sub_region_2) & date > "2020-03-01")
# state level sah only
sah_states <- sah %>% filter(county == 'All')
sah_counties <- sah %>% filter(county != 'All')

# join sah and google data
df_joined <- inner_join(mob_data_filtered, sah_states, by=c('sub_region_1' = c('state')))

# mobility change in NY County by type
df_joined %>% 
  filter(sub_region_1 == "Colorado" & sub_region_2 == "Boulder County" 
         & date < order_date) %>%
  select("date","retail_and_recreation_percent_change_from_baseline",
        "grocery_and_pharmacy_percent_change_from_baseline",
        "parks_percent_change_from_baseline",
        "transit_stations_percent_change_from_baseline",
        "workplaces_percent_change_from_baseline",
        "residential_percent_change_from_baseline")%>%
  gather(key = "variable", value = "value", -date) %>% 
  mutate(type = str_replace(variable, "_percent_change_from_baseline", ""))%>%
  ggplot(aes(y = value,x = date, group= type, color = type))+
  geom_line() +
  ggtitle("Percent Change From Baseline Before State Stay-at-Home")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90), 
        legend.title = element_blank(),
        legend.position="bottom") +
  scale_x_date(date_breaks = "1 day")
```


# Decrease in Mobility
Narrow Down Counties that may have had a local Stay-at-Home order before State
- Check decrease in mobility for every county after state SAH implemented
If there is a decrease in numbers close to what was seen after state level stay-at-home in the days before, the county may have had a local stay-at-home order in place.
- Exclude day before state-level SAH implementation from analysis?
```{r}
# get mobility for the day after state order_date
# not sure why -1 works and not +1 to get next day
state_mob <- df_joined %>% filter(order_date == date-1) %>% 
  select(c(3:4,10))

# join drop after state SAH to original data
local_mob <- merge(df_joined,state_mob, by = c("sub_region_1","sub_region_2"))

# for every county, filter to dates before state stay-at-home
# for every county- calculate highest drop in workplaces (min)
# filter counties where there was a higher drop before state stay-at-home
# if there are ties in workplace for a county- pick earliest date
# order_date = state stay-at-home order date
# drop_date = date of biggest drop before 
# county_wp_drop = % workplace drop from baseline on drop_date
# state_wp_drop = % workplace drop from baseline on order_date
county_state_mob <- local_mob %>% 
  group_by(sub_region_1, sub_region_2, date) %>% 
  filter(date < order_date) %>% 
  mutate(county_wp_drop = min(workplaces_percent_change_from_baseline.x)) %>% 
  filter(county_wp_drop < workplaces_percent_change_from_baseline.y) %>% 
  group_by(sub_region_1, sub_region_2, order_date) %>% 
  summarise(drop_date = min(date), 
            county_wp_drop = min(county_wp_drop),
            state_wp_drop = min(workplaces_percent_change_from_baseline.y)) %>% 
  arrange(county_wp_drop)
# days_between = days between order_date and drop_date
county_state_mob$days_between <- county_state_mob$order_date - 
  county_state_mob$drop_date
```

```{r}
datatable(county_state_mob)
```

