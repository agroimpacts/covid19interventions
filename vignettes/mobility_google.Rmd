---
title: "Google Mobility Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mobility_google}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, include=TRUE, message=FALSE}
library(covid19interventions)
library(rvest)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(readr)
library(DT)
library(changepoint)
```

## Google Mobility Data
- Find date of biggest drop in mobility by county using google data
- Check if this happens before or after SAH order is implemented
- If a big drop before SAH -> there may be some county level implementation (?)
```{r, fig.align='center', fig.width=8, fig.height=5, message=FALSE}
# load sah state from webscraping
load(file = "../data/sah.rda")
# global dataset
mob_data <- read_csv("../data/Global_Mobility_Report.csv")
mob_data$date = as.Date(mob_data$date, format = '%m/%d/%Y')

# filter data to county level data only
mob_data_filtered <- mob_data %>% filter(!is.na(sub_region_2))
# state level sah only
sah_states <- sah %>% filter(county == 'All')
sah_counties <- sah %>% filter(county != 'All')

# join sah and google data
df_joined <- inner_join(mob_data_filtered, sah_states, by=c('sub_region_1' = c('state')))
```

## Change Point Detection
```{r, warning=FALSE, include=TRUE, message=FALSE, results=FALSE}
# select unique state and county in dataframe
state_county <- df_joined %>% select(sub_region_1,sub_region_2) %>% distinct() 

# create blank df for loop
county_wp_mean <- data.frame(sub_region_1 = character(), 
                sub_region_2 = character(), 
                wp_low_mean = double())

# for each county, extract workplace numbers as numeric
# filter to dates before state stay at home and remove NA values
for (i in 1:nrow(state_county)){
    # workplace sorted by date as numeric
    # print (c(state_county$sub_region_1[i], state_county$sub_region_2[i] ))
    county <- df_joined %>% filter(sub_region_1 == state_county$sub_region_1[i] & 
                               sub_region_2 == state_county$sub_region_2[i] &
                               date < order_date &
                               !is.na(workplaces_percent_change_from_baseline)) %>%
    select('workplaces_percent_change_from_baseline') %>% 
    as.matrix() %>% 
    as.numeric()
    # exclude counties that do not have enough data points
    # need at least 2 data points for change detection
    # county must have at least a month of data to be included (?)
    if (length(county) > 30){
    # Change detection to identify changes in mean
    # changes in variance didn't return much
    # using AMOC:At Most One Change method
    county_mean <- cpt.mean(county,method='AMOC')
    # print lowest change in mean before state stay at home
    low_mean <- min(param.est(county_mean)$mean)
    # add to dataframe
    county_wp_mean <- rbind(county_wp_mean, 
                            data.frame(sub_region_1 = state_county$sub_region_1[i],
                                  sub_region_2 = state_county$sub_region_2[i],
                                  wp_low_mean = round(low_mean, 2)))
  }
}

# sort ascending and filter counties with highest drop (-50%+)
top_counties <- county_wp_mean %>% 
  arrange(wp_low_mean) %>% 
  filter(wp_low_mean <= -50)
```

```{r}
datatable(top_counties)
```

## Test Mean Change by County
```{r, fig.align='center', fig.width=8, fig.height=5}
# Test for one county
x <-  df_joined %>% filter(sub_region_1 == "Virginia" & 
                             sub_region_2 == "Falls Church" &
                             date < order_date &
                             !is.na(workplaces_percent_change_from_baseline)) %>%
  select('workplaces_percent_change_from_baseline') %>%  
  as.matrix() %>% 
  as.numeric()
# changes in mean
v1.man=cpt.mean(x,method='AMOC')
# example plot
plot(v1.man,cpt.col='blue')
# print means
param.est(v1.man)$mean
```


```{r, fig.align='center', fig.width=8, fig.height=5}
# mobility change in County by type
df_joined %>% 
  filter(sub_region_1 == "California" & sub_region_2 == "San Francisco County") %>%
  select("date",
        "workplaces_percent_change_from_baseline")%>%
  gather(key = "variable", value = "value", -date) %>% 
  mutate(type = str_replace(variable, "_percent_change_from_baseline", ""))%>%
  ggplot(aes(y = value,x = date, group= type, color = type))+
  geom_line() +
  ggtitle("Workplace Percent Change From Baseline")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90), 
        legend.title = element_blank(),
        legend.position="bottom") +
  scale_x_date(date_breaks = "1 day")
```

## Decrease in Mobility by County
Narrow Down Counties that may have had a local Stay-at-Home order before State
- Check decrease in workplace for every county after state SAH implemented

- If there is a larger decrease before state level stay-at-home- the county may have had a local stay-at-home order in place.

- Exclude day before state-level SAH implementation from analysis? (filter by days_between if needed)
```{r, eval=FALSE}
# get mobility for the day after state order_date
# not sure why -1 works and not +1 to get next day
state_mob <- df_joined %>% 
  filter(order_date == date-1) %>% 
  select(c(3:4,10))

# join drop after state SAH to original data
local_mob <- merge(df_joined,state_mob, by = c("sub_region_1","sub_region_2"))

# for every county, filter to dates before state stay-at-home
# for every county- calculate highest drop in workplaces (min)
# filter counties where there was a higher drop before state stay-at-home
# if there are ties in workplace % for a county- pick earliest date
county_state_mob <- local_mob %>% 
  group_by(sub_region_1, sub_region_2, date) %>% 
  filter(date < order_date) %>% 
  mutate(county_wp_drop = min(workplaces_percent_change_from_baseline.x)) %>% 
  filter(county_wp_drop < workplaces_percent_change_from_baseline.y) %>% 
  group_by(sub_region_1, sub_region_2, order_date) %>% 
  summarise(drop_date = min(date), 
            county_wp_drop = min(county_wp_drop),
            state_wp_drop = min(workplaces_percent_change_from_baseline.y)) %>% 
  arrange(county_wp_drop)

county_state_mob$days_between <- county_state_mob$order_date - 
  county_state_mob$drop_date
```

```{r, eval=FALSE}
# order_date = state stay-at-home order date
# drop_date = date of biggest drop before 
# county_wp_drop = % workplace drop from baseline on drop_date
# state_wp_drop = % workplace drop from baseline on order_date
# days_between = days between order_date and drop_date
datatable(county_state_mob)
```
